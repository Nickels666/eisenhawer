<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eisenhower Matrix - Mental Models Dashboard</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css">
    
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #4895ef;
            --primary-dark: #3a0ca3;
            --secondary: #4cc9f0;
            --accent: #f72585;
            --success: #4caf50;
            --warning: #ff9800;
            --danger: #f44336;
            --light: #f8f9fa;
            --dark: #212529;
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;
            
            /* Border radius */
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: #f5f7fa;
            color: var(--gray-800);
        }
        
        .card {
            border: none;
            border-radius: var(--radius-md);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }
        
        .matrix-container {
            position: relative;
            width: 100%;
            height: 500px;
            border: 2px solid var(--gray-300);
            border-radius: var(--radius-md);
            background-color: white;
        }
        
        .matrix-quadrant-lines {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .vertical-line {
            position: absolute;
            top: 0;
            left: 50%;
            height: 100%;
            width: 2px;
            background-color: var(--gray-300);
        }
        
        .horizontal-line {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: var(--gray-300);
        }
        
        .quadrant-label {
            position: absolute;
            font-weight: 600;
            font-size: 0.9rem;
            padding: 0.5rem;
        }
        
        /* Corrected quadrant label positions and colors */
        .q1-label { /* DECIDE - Important, Not Urgent */
            top: 10px;
            left: 10px;
            color: #ff9800;
        }
        
        .q2-label { /* DO - Important & Urgent */
            top: 10px;
            right: 10px;
            color: #f44336;
        }
        
        .q3-label { /* DELETE - Not Important or Urgent */
            bottom: 10px;
            left: 10px;
            color: #757575;
        }
        
        .q4-label { /* DELEGATE - Urgent, Not Important */
            bottom: 10px;
            right: 10px;
            color: #2196f3;
        }
        
        .axis-label {
            position: absolute;
            font-size: 0.85rem;
            color: var(--gray-600);
            font-weight: 500;
        }
        
        .x-axis-label {
            bottom: -30px;
            left: 0;
            width: 100%;
            text-align: center;
        }
        
        .y-axis-label {
            top: 50%;
            left: -40px;
            transform: rotate(-90deg) translateX(-50%);
            transform-origin: left center;
        }
        
        .task-point {
            position: absolute;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.75rem;
            cursor: grab;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        .task-point:hover {
            transform: translate(-50%, -50%) scale(1.1);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .task-point.selected {
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.7), 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        
        .task-card {
            border-left-width: 4px;
            transition: all 0.2s ease;
        }
        
        .task-card:hover {
            transform: translateY(-2px);
        }
        
        .task-card.selected {
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.3);
        }
        
        .task-form-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .task-form {
            background-color: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        /* Custom range input styling */
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--gray-200);
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: none;
        }
        
        .stats-card {
            border-left-width: 4px;
            transition: all 0.2s ease;
        }
        
        .view-toggle .btn {
            border-radius: 0;
        }
        
        .view-toggle .btn:first-child {
            border-top-left-radius: var(--radius-md);
            border-bottom-left-radius: var(--radius-md);
        }
        
        .view-toggle .btn:last-child {
            border-top-right-radius: var(--radius-md);
            border-bottom-right-radius: var(--radius-md);
        }
        
        .quadrant-container {
            border-top-width: 4px;
            border-radius: var(--radius-md);
            height: 100%;
        }
        
        .task-item {
            border-radius: var(--radius-sm);
            margin-bottom: 0.75rem;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <header class="mb-5">
            <h1 class="display-5 fw-bold text-primary mb-2">Mental Models Dashboard</h1>
            <p class="text-muted">Interactive Eisenhower Matrix Implementation</p>
        </header>
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="h3 mb-0">Eisenhower Matrix</h2>
            
            <div class="d-flex gap-3">
                <div class="btn-group view-toggle" role="group">
                    <button type="button" class="btn btn-primary active" id="chartViewBtn">Chart View</button>
                    <button type="button" class="btn btn-outline-primary" id="listViewBtn">List View</button>
                </div>
                
                <button class="btn btn-primary" id="addTaskBtn">
                    <i class="bi bi-plus-circle me-1"></i> Add Task
                </button>
            </div>
        </div>
        
        <!-- Chart View -->
        <div id="chartView" class="mb-4">
            <div class="card">
                <div class="card-body p-4">
                    <div class="matrix-container" id="matrixChart">
                        <div class="matrix-quadrant-lines">
                            <div class="vertical-line"></div>
                            <div class="horizontal-line"></div>
                            
                            <div class="quadrant-label q2-label">DO<br><small>Important & Urgent</small></div>
                            <div class="quadrant-label q1-label">DECIDE<br><small>Important, Not Urgent</small></div>
                            <div class="quadrant-label q4-label">DELEGATE<br><small>Urgent, Not Important</small></div>
                            <div class="quadrant-label q3-label">DELETE<br><small>Not Important or Urgent</small></div>
                            
                            <div class="axis-label x-axis-label">Urgency</div>
                            <div class="axis-label y-axis-label">Importance</div>
                        </div>
                        
                        <!-- Task points will be added here dynamically -->
                    </div>
                    
                    <div class="mt-4">
                        <h5 class="mb-3">Task Legend</h5>
                        <div class="row" id="taskLegend">
                            <!-- Task cards will be added here dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- List View -->
        <div id="listView" class="mb-4" style="display: none;">
            <div class="row g-4">
                <!-- Do Quadrant -->
                <div class="col-md-6">
                    <div class="card quadrant-container border-danger h-100">
                        <div class="card-body">
                            <h5 class="card-title text-danger">Do</h5>
                            <p class="text-muted small mb-3">Urgent & Important</p>
                            <div id="doTasks">
                                <!-- Tasks will be added here dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Decide Quadrant -->
                <div class="col-md-6">
                    <div class="card quadrant-container border-warning h-100">
                        <div class="card-body">
                            <h5 class="card-title text-warning">Decide</h5>
                            <p class="text-muted small mb-3">Important, Not Urgent</p>
                            <div id="decideTasks">
                                <!-- Tasks will be added here dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Delegate Quadrant -->
                <div class="col-md-6">
                    <div class="card quadrant-container border-primary h-100">
                        <div class="card-body">
                            <h5 class="card-title text-primary">Delegate</h5>
                            <p class="text-muted small mb-3">Urgent, Not Important</p>
                            <div id="delegateTasks">
                                <!-- Tasks will be added here dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Delete Quadrant -->
                <div class="col-md-6">
                    <div class="card quadrant-container border-secondary h-100">
                        <div class="card-body">
                            <h5 class="card-title text-secondary">Delete</h5>
                            <p class="text-muted small mb-3">Not Important or Urgent</p>
                            <div id="deleteTasks">
                                <!-- Tasks will be added here dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Task Details Panel -->
        <div id="taskDetailsPanel" class="card mb-4" style="display: none;">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h4 id="taskDetailsTitle" class="mb-2"></h4>
                        <div class="d-flex gap-3">
                            <div class="text-muted small">
                                Importance: <span id="taskDetailsImportance" class="fw-medium"></span>
                            </div>
                            <div class="text-muted small">
                                Urgency: <span id="taskDetailsUrgency" class="fw-medium"></span>
                            </div>
                            <div class="text-muted small">
                                Quadrant: <span id="taskDetailsQuadrant" class="fw-medium text-capitalize"></span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-2" id="editTaskBtn">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-danger" id="deleteTaskBtn">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Task Summary -->
        <div class="card">
            <div class="card-body">
                <h5 class="card-title mb-3">Task Summary</h5>
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="stats-card card border-start border-danger bg-danger bg-opacity-10 h-100">
                            <div class="card-body py-3">
                                <div class="text-muted small">Do Tasks</div>
                                <div class="h3 text-danger mb-0" id="doCount">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card card border-start border-warning bg-warning bg-opacity-10 h-100">
                            <div class="card-body py-3">
                                <div class="text-muted small">Decide Tasks</div>
                                <div class="h3 text-warning mb-0" id="decideCount">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card card border-start border-primary bg-primary bg-opacity-10 h-100">
                            <div class="card-body py-3">
                                <div class="text-muted small">Delegate Tasks</div>
                                <div class="h3 text-primary mb-0" id="delegateCount">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stats-card card border-start border-secondary bg-secondary bg-opacity-10 h-100">
                            <div class="card-body py-3">
                                <div class="text-muted small">Delete Tasks</div>
                                <div class="h3 text-secondary mb-0" id="deleteCount">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Task Form Modal (Hidden by default) -->
        <div class="task-form-overlay" id="taskFormOverlay" style="display: none;">
            <div class="task-form">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 id="taskFormTitle">Add New Task</h4>
                    <button type="button" class="btn-close" id="closeTaskForm"></button>
                </div>
                
                <form id="taskForm">
                    <input type="hidden" id="taskId">
                    
                    <div class="mb-3">
                        <label for="taskTitle" class="form-label">Task Title</label>
                        <input type="text" class="form-control" id="taskTitle" placeholder="Enter task title" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="taskImportance" class="form-label">
                            Importance: <span id="importanceValue">5</span>/10
                        </label>
                        <input type="range" class="form-range" min="1" max="10" value="5" id="taskImportance">
                    </div>
                    
                    <div class="mb-4">
                        <label for="taskUrgency" class="form-label">
                            Urgency: <span id="urgencyValue">5</span>/10
                        </label>
                        <input type="range" class="form-range" min="1" max="10" value="5" id="taskUrgency">
                    </div>
                    
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-outline-secondary" id="cancelTaskForm">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="saveTaskBtn">
                            <i class="bi bi-check-lg me-1"></i> Save Task
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Configuration
        const TASKS_JSON_URL = 'data/tasks.json';
        const REFRESH_INTERVAL = 60000; // Check for updates every minute
        
        // Generate a unique ID for this user/device if not already created
        let userId = localStorage.getItem('eisenhowerMatrixUserId');
        if (!userId) {
            userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('eisenhowerMatrixUserId', userId);
        }
        
        // Default tasks (used as fallback if JSON loading fails)
        let defaultTasks = [
            { id: 1, title: "Complete quarterly report", importance: 9, urgency: 8, quadrant: "do", color: "#f44336" },
            { id: 2, title: "Prepare presentation for client", importance: 8, urgency: 9, quadrant: "do", color: "#f44336" },
            { id: 3, title: "Strategic planning session", importance: 9, urgency: 4, quadrant: "decide", color: "#ff9800" },
            { id: 4, title: "Professional development course", importance: 8, urgency: 3, quadrant: "decide", color: "#ff9800" },
            { id: 5, title: "Respond to routine emails", importance: 3, urgency: 7, quadrant: "delegate", color: "#2196f3" },
            { id: 6, title: "Weekly team status updates", importance: 4, urgency: 6, quadrant: "delegate", color: "#2196f3" },
            { id: 7, title: "Office supply inventory", importance: 2, urgency: 2, quadrant: "delete", color: "#757575" },
            { id: 8, title: "Social media browsing", importance: 1, urgency: 1, quadrant: "delete", color: "#757575" },
        ];
        
        // Current tasks data
        let tasks = [];
        
        // Load tasks from JSON file
        async function loadTasksFromJSON() {
            try {
                // Add cache-busting parameter to avoid browser caching
                const response = await fetch(`${TASKS_JSON_URL}?_=${Date.now()}`);
                
                if (!response.ok) {
                    throw new Error(`Failed to load tasks: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Extract tasks for this user or use default user's tasks
                if (data.tasks && data.tasks[userId]) {
                    tasks = data.tasks[userId];
                } else if (data.tasks && data.tasks.user_default) {
                    // If user's tasks don't exist, use default tasks from JSON
                    tasks = data.tasks.user_default;
                } else {
                    // Fallback to default tasks
                    tasks = defaultTasks;
                }
                
                // Save to localStorage as backup
                saveTasksLocally();
                
                // Update UI
                renderTasks();
                console.log('Tasks loaded successfully');
                
                // Update status indicator
                updateSyncStatus('Tasks loaded ✓', 'success');
            } catch (error) {
                console.error('Error loading tasks:', error);
                // Fall back to localStorage
                loadTasksFromLocalStorage();
                
                // Update status indicator
                updateSyncStatus('Failed to load tasks', 'error');
            }
        }
        
        // Load tasks from localStorage backup
        function loadTasksFromLocalStorage() {
            const localTasks = localStorage.getItem('eisenhowerMatrixTasks');
            
            if (localTasks) {
                tasks = JSON.parse(localTasks);
                renderTasks();
                console.log('Tasks loaded from local storage');
            } else {
                // If no local tasks, use defaults
                tasks = defaultTasks;
                renderTasks();
                console.log('Using default tasks');
            }
        }
        
        // Save tasks to localStorage
        function saveTasksLocally() {
            localStorage.setItem('eisenhowerMatrixTasks', JSON.stringify(tasks));
        }
        
        // Update the sync status indicator
        function updateSyncStatus(message, type) {
            const syncStatus = document.getElementById('syncStatus');
            if (syncStatus) {
                syncStatus.textContent = message;
                
                // Reset classes
                syncStatus.classList.remove('text-success', 'text-danger', 'text-warning');
                
                // Add appropriate class
                if (type === 'success') {
                    syncStatus.classList.add('text-success');
                } else if (type === 'error') {
                    syncStatus.classList.add('text-danger');
                } else if (type === 'warning') {
                    syncStatus.classList.add('text-warning');
                }
                
                // Reset after a delay
                setTimeout(() => {
                    syncStatus.textContent = 'Saved locally';
                    syncStatus.classList.remove('text-success', 'text-danger', 'text-warning');
                }, 3000);
            }
        }
        
        // Set up periodic refresh to check for updates
        function setupPeriodicRefresh() {
            setInterval(() => {
                loadTasksFromJSON();
            }, REFRESH_INTERVAL);
        }
        
        // DOM elements
        const matrixChart = document.getElementById('matrixChart');
        const taskLegend = document.getElementById('taskLegend');
        const chartViewBtn = document.getElementById('chartViewBtn');
        const listViewBtn = document.getElementById('listViewBtn');
        const chartView = document.getElementById('chartView');
        const listView = document.getElementById('listView');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const taskFormOverlay = document.getElementById('taskFormOverlay');
        const closeTaskForm = document.getElementById('closeTaskForm');
        const cancelTaskForm = document.getElementById('cancelTaskForm');
        const taskForm = document.getElementById('taskForm');
        const taskFormTitle = document.getElementById('taskFormTitle');
        const taskId = document.getElementById('taskId');
        const taskTitle = document.getElementById('taskTitle');
        const taskImportance = document.getElementById('taskImportance');
        const taskUrgency = document.getElementById('taskUrgency');
        const importanceValue = document.getElementById('importanceValue');
        const urgencyValue = document.getElementById('urgencyValue');
        const saveTaskBtn = document.getElementById('saveTaskBtn');
        const taskDetailsPanel = document.getElementById('taskDetailsPanel');
        const taskDetailsTitle = document.getElementById('taskDetailsTitle');
        const taskDetailsImportance = document.getElementById('taskDetailsImportance');
        const taskDetailsUrgency = document.getElementById('taskDetailsUrgency');
        const taskDetailsQuadrant = document.getElementById('taskDetailsQuadrant');
        const editTaskBtn = document.getElementById('editTaskBtn');
        const deleteTaskBtn = document.getElementById('deleteTaskBtn');
        const doTasks = document.getElementById('doTasks');
        const decideTasks = document.getElementById('decideTasks');
        const delegateTasks = document.getElementById('delegateTasks');
        const deleteTasks = document.getElementById('deleteTasks');
        const doCount = document.getElementById('doCount');
        const decideCount = document.getElementById('decideCount');
        const delegateCount = document.getElementById('delegateCount');
        const deleteCount = document.getElementById('deleteCount');
        
        // State variables
        let selectedTask = null;
        let isDragging = false;
        
        // Helper functions
        function getQuadrantDetails(importance, urgency) {
            // Corrected quadrant assignments to match the standard Eisenhower Matrix:
            // Top-left: DECIDE (Important, Not Urgent)
            // Top-right: DO (Important & Urgent)
            // Bottom-left: DELETE (Not Important or Urgent)
            // Bottom-right: DELEGATE (Urgent, Not Important)
            
            if (importance > 5 && urgency > 5) {
                return { quadrant: "do", color: "#f44336", bgColor: "#f8d7da" }; // Top-right
            } else if (importance > 5 && urgency <= 5) {
                return { quadrant: "decide", color: "#ff9800", bgColor: "#fff3cd" }; // Top-left
            } else if (importance <= 5 && urgency > 5) {
                return { quadrant: "delegate", color: "#2196f3", bgColor: "#cfe2ff" }; // Bottom-right
            } else {
                return { quadrant: "delete", color: "#757575", bgColor: "#e2e3e5" }; // Bottom-left
            }
        }
        
        function renderTasks() {
            // Clear existing task points and cards
            const existingPoints = document.querySelectorAll('.task-point');
            existingPoints.forEach(point => point.remove());
            
            taskLegend.innerHTML = '';
            doTasks.innerHTML = '';
            decideTasks.innerHTML = '';
            delegateTasks.innerHTML = '';
            deleteTasks.innerHTML = '';
            
            // Update counters
            const counts = {
                do: tasks.filter(task => task.quadrant === "do").length,
                decide: tasks.filter(task => task.quadrant === "decide").length,
                delegate: tasks.filter(task => task.quadrant === "delegate").length,
                delete: tasks.filter(task => task.quadrant === "delete").length
            };
            
            doCount.textContent = counts.do;
            decideCount.textContent = counts.decide;
            delegateCount.textContent = counts.delegate;
            deleteCount.textContent = counts.delete;
            
            // Render each task
            tasks.forEach(task => {
                // Calculate position for chart view
                const left = (task.urgency / 10) * 100;
                const top = ((10 - task.importance) / 10) * 100;
                
                // Create task point for chart view
                const taskPoint = document.createElement('div');
                taskPoint.className = `task-point ${selectedTask && selectedTask.id === task.id ? 'selected' : ''}`;
                taskPoint.style.left = `${left}%`;
                taskPoint.style.top = `${top}%`;
                taskPoint.style.backgroundColor = task.color;
                taskPoint.textContent = task.id;
                taskPoint.dataset.id = task.id;
                
                taskPoint.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    handleTaskSelect(task);
                    startDragging(task, e);
                });
                
                matrixChart.appendChild(taskPoint);
                
                // Create task card for legend
                const taskCard = document.createElement('div');
                taskCard.className = 'col-md-6 col-lg-3 mb-3';
                taskCard.innerHTML = `
                    <div class="card task-card border-start ${selectedTask && selectedTask.id === task.id ? 'selected' : ''}" 
                         style="border-left-color: ${task.color}; background-color: ${task.color}10;">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-start">
                                <div class="me-2 d-flex align-items-center justify-content-center rounded-circle" 
                                     style="width: 24px; height: 24px; background-color: ${task.color};">
                                    <span class="text-white small fw-bold">${task.id}</span>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="fw-medium">${task.title}</div>
                                    <div class="text-muted small mt-1">
                                        Importance: ${task.importance} | Urgency: ${task.urgency}
                                    </div>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-link text-muted p-0 me-1" 
                                            onclick="handleEditTask(${task.id})">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-link text-muted p-0" 
                                            onclick="handleDeleteTask(${task.id})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                taskCard.querySelector('.task-card').addEventListener('click', () => {
                    handleTaskSelect(task);
                });
                
                taskLegend.appendChild(taskCard);
                
                // Create task item for list view
                const taskItem = document.createElement('div');
                taskItem.className = 'task-item p-3';
                taskItem.style.backgroundColor = task.color;
                taskItem.style.opacity = '0.9';
                taskItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-start">
                        <p class="fw-medium text-white mb-1">${task.title}</p>
                        <div>
                            <button class="btn btn-sm btn-link text-white p-0 me-1" 
                                    onclick="handleEditTask(${task.id})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-link text-white p-0" 
                                    onclick="handleDeleteTask(${task.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="d-flex text-white small">
                        <span class="me-2">I: ${task.importance}/10</span>
                        <span>U: ${task.urgency}/10</span>
                    </div>
                `;
                
                // Add to appropriate quadrant
                if (task.quadrant === 'do') {
                    doTasks.appendChild(taskItem);
                } else if (task.quadrant === 'decide') {
                    decideTasks.appendChild(taskItem);
                } else if (task.quadrant === 'delegate') {
                    delegateTasks.appendChild(taskItem);
                } else {
                    deleteTasks.appendChild(taskItem);
                }
            });
        }
        
        function handleTaskSelect(task) {
            selectedTask = task;
            
            // Update task details panel
            taskDetailsTitle.textContent = task.title;
            taskDetailsImportance.textContent = `${task.importance}/10`;
            taskDetailsUrgency.textContent = `${task.urgency}/10`;
            taskDetailsQuadrant.textContent = task.quadrant;
            
            // Show task details panel
            taskDetailsPanel.style.display = 'block';
            
            // Update selected state in UI
            renderTasks();
        }
        
        function startDragging(task, event) {
            isDragging = true;
            
            const handleMouseMove = (e) => {
                if (!isDragging) return;
                
                const rect = matrixChart.getBoundingClientRect();
                
                // Calculate relative position
                let x = e.clientX - rect.left;
                let y = e.clientY - rect.top;
                
                // Constrain to chart boundaries
                x = Math.max(0, Math.min(rect.width, x));
                y = Math.max(0, Math.min(rect.height, y));
                
                // Convert to urgency/importance (0-10 scale)
                const urgency = (x / rect.width) * 10;
                const importance = 10 - (y / rect.height) * 10;
                
                // Update task
                const updatedTask = {
                    ...task,
                    importance: Math.max(1, Math.min(10, Math.round(importance))),
                    urgency: Math.max(1, Math.min(10, Math.round(urgency)))
                };
                
                // Update quadrant and color
                const { quadrant, color } = getQuadrantDetails(updatedTask.importance, updatedTask.urgency);
                updatedTask.quadrant = quadrant;
                updatedTask.color = color;
                
                // Update tasks array
                tasks = tasks.map(t => t.id === task.id ? updatedTask : t);
                
                // Update selected task
                selectedTask = updatedTask;
                
                // Update UI
                renderTasks();
            };
            
            const handleMouseUp = () => {
                isDragging = false;
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
            };
            
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        }
        
        function handleAddTask() {
            // Reset form
            taskId.value = '';
            taskTitle.value = '';
            taskImportance.value = 5;
            taskUrgency.value = 5;
            importanceValue.textContent = 5;
            urgencyValue.textContent = 5;
            
            // Update form title
            taskFormTitle.textContent = 'Add New Task';
            
            // Show form
            taskFormOverlay.style.display = 'flex';
        }
        
        function handleEditTask(id) {
            const task = tasks.find(t => t.id === id);
            if (!task) return;
            
            // Fill form with task data
            taskId.value = task.id;
            taskTitle.value = task.title;
            taskImportance.value = task.importance;
            taskUrgency.value = task.urgency;
            importanceValue.textContent = task.importance;
            urgencyValue.textContent = task.urgency;
            
            // Update form title
            taskFormTitle.textContent = 'Edit Task';
            
            // Show form
            taskFormOverlay.style.display = 'flex';
        }
        
        function handleDeleteTask(id) {
            if (confirm('Are you sure you want to delete this task?')) {
                tasks = tasks.filter(task => task.id !== id);
                
                if (selectedTask && selectedTask.id === id) {
                    selectedTask = null;
                    taskDetailsPanel.style.display = 'none';
                }
                
                renderTasks();
            }
        }
        
        function handleSaveTask(e) {
            e.preventDefault();
            
            const title = taskTitle.value.trim();
            if (!title) return;
            
            const importance = parseInt(taskImportance.value);
            const urgency = parseInt(taskUrgency.value);
            
            const { quadrant, color } = getQuadrantDetails(importance, urgency);
            
            if (taskId.value) {
                // Edit existing task
                const id = parseInt(taskId.value);
                tasks = tasks.map(task => {
                    if (task.id === id) {
                        const updatedTask = {
                            ...task,
                            title,
                            importance,
                            urgency,
                            quadrant,
                            color
                        };
                        
                        if (selectedTask && selectedTask.id === id) {
                            selectedTask = updatedTask;
                        }
                        
                        return updatedTask;
                    }
                    return task;
                });
            } else {
                // Add new task
                const newTask = {
                    id: Date.now(),
                    title,
                    importance,
                    urgency,
                    quadrant,
                    color
                };
                
                tasks.push(newTask);
            }
            
            // Close form and update UI
            taskFormOverlay.style.display = 'none';
            renderTasks();
            
            // Update task details panel if needed
            if (selectedTask) {
                taskDetailsTitle.textContent = selectedTask.title;
                taskDetailsImportance.textContent = `${selectedTask.importance}/10`;
                taskDetailsUrgency.textContent = `${selectedTask.urgency}/10`;
                taskDetailsQuadrant.textContent = selectedTask.quadrant;
            }
        }
        
        // Event listeners
        chartViewBtn.addEventListener('click', () => {
            chartViewBtn.classList.add('active');
            chartViewBtn.classList.remove('btn-outline-primary');
            chartViewBtn.classList.add('btn-primary');
            
            listViewBtn.classList.remove('active');
            listViewBtn.classList.add('btn-outline-primary');
            listViewBtn.classList.remove('btn-primary');
            
            chartView.style.display = 'block';
            listView.style.display = 'none';
        });
        
        listViewBtn.addEventListener('click', () => {
            listViewBtn.classList.add('active');
            listViewBtn.classList.remove('btn-outline-primary');
            listViewBtn.classList.add('btn-primary');
            
            chartViewBtn.classList.remove('active');
            chartViewBtn.classList.add('btn-outline-primary');
            chartViewBtn.classList.remove('btn-primary');
            
            listView.style.display = 'block';
            chartView.style.display = 'none';
        });
        
        addTaskBtn.addEventListener('click', handleAddTask);
        
        closeTaskForm.addEventListener('click', () => {
            taskFormOverlay.style.display = 'none';
        });
        
        cancelTaskForm.addEventListener('click', () => {
            taskFormOverlay.style.display = 'none';
        });
        
        taskForm.addEventListener('submit', handleSaveTask);
        
        taskImportance.addEventListener('input', () => {
            importanceValue.textContent = taskImportance.value;
        });
        
        taskUrgency.addEventListener('input', () => {
            urgencyValue.textContent = taskUrgency.value;
        });
        
        editTaskBtn.addEventListener('click', () => {
            if (selectedTask) {
                handleEditTask(selectedTask.id);
            }
        });
        
        deleteTaskBtn.addEventListener('click', () => {
            if (selectedTask) {
                handleDeleteTask(selectedTask.id);
            }
        });
        
        matrixChart.addEventListener('click', (e) => {
            if (isDragging) return;
            
            // Check if clicked on a task point
            if (e.target.classList.contains('task-point')) return;
            
            const rect = matrixChart.getBoundingClientRect();
            
            // Calculate relative position
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Convert to urgency/importance (0-10 scale)
            const urgency = (x / rect.width) * 10;
            const importance = 10 - (y / rect.height) * 10;
            
            // Reset form
            taskId.value = '';
            taskTitle.value = '';
            taskImportance.value = Math.max(1, Math.min(10, Math.round(importance)));
            taskUrgency.value = Math.max(1, Math.min(10, Math.round(urgency)));
            importanceValue.textContent = taskImportance.value;
            urgencyValue.textContent = taskUrgency.value;
            
            // Update form title
            taskFormTitle.textContent = 'Add New Task';
            
            // Show form
            taskFormOverlay.style.display = 'flex';
        });
        
        // Make functions available globally for onclick handlers
        window.handleEditTask = handleEditTask;
        window.handleDeleteTask = handleDeleteTask;
        
        // Add sync status indicator to the UI
        const statusIndicator = document.createElement('div');
        statusIndicator.className = 'position-fixed bottom-0 end-0 m-3 p-3 bg-primary text-white rounded shadow d-flex align-items-center';
        statusIndicator.style.zIndex = '9999'; // Ensure it's on top
        statusIndicator.innerHTML = '<i class="bi bi-cloud-check me-2"></i><span id="syncStatus" style="font-weight: bold;">Saved locally</span>';
        document.body.appendChild(statusIndicator);
        
        // Optional: Add an export button for manual sync
        const exportBtn = document.createElement('button');
        exportBtn.className = 'btn btn-sm btn-outline-primary ms-2';
        exportBtn.innerHTML = '<i class="bi bi-cloud-upload"></i> Sync Tasks';
        exportBtn.title = 'This would trigger your n8n workflow to update tasks';
        exportBtn.addEventListener('click', () => {
            updateSyncStatus('Sync requested (n8n integration required)', 'warning');
        });
        document.querySelector('.d-flex.gap-3').appendChild(exportBtn);
        
        // Override the handleSaveTask function to include local storage
        const originalHandleSaveTask = handleSaveTask;
        handleSaveTask = function(e) {
            originalHandleSaveTask(e);
            saveTasksLocally();
            updateSyncStatus('Saved locally ✓', 'success');
        };
        
        // Override the handleDeleteTask function to include local storage
        const originalHandleDeleteTask = handleDeleteTask;
        handleDeleteTask = function(id) {
            if (confirm('Are you sure you want to delete this task?')) {
                tasks = tasks.filter(task => task.id !== id);
                
                if (selectedTask && selectedTask.id === id) {
                    selectedTask = null;
                    taskDetailsPanel.style.display = 'none';
                }
                
                renderTasks();
                saveTasksLocally();
                updateSyncStatus('Saved locally ✓', 'success');
            }
        };
        
        // Override the startDragging function to include local storage when dragging ends
        const originalStartDragging = startDragging;
        startDragging = function(task, event) {
            isDragging = true;
            
            const handleMouseMove = (e) => {
                if (!isDragging) return;
                
                const rect = matrixChart.getBoundingClientRect();
                
                // Calculate relative position
                let x = e.clientX - rect.left;
                let y = e.clientY - rect.top;
                
                // Constrain to chart boundaries
                x = Math.max(0, Math.min(rect.width, x));
                y = Math.max(0, Math.min(rect.height, y));
                
                // Convert to urgency/importance (0-10 scale)
                const urgency = (x / rect.width) * 10;
                const importance = 10 - (y / rect.height) * 10;
                
                // Update task
                const updatedTask = {
                    ...task,
                    importance: Math.max(1, Math.min(10, Math.round(importance))),
                    urgency: Math.max(1, Math.min(10, Math.round(urgency)))
                };
                
                // Update quadrant and color
                const { quadrant, color } = getQuadrantDetails(updatedTask.importance, updatedTask.urgency);
                updatedTask.quadrant = quadrant;
                updatedTask.color = color;
                
                // Update tasks array
                tasks = tasks.map(t => t.id === task.id ? updatedTask : t);
                
                // Update selected task
                selectedTask = updatedTask;
                
                // Update UI
                renderTasks();
            };
            
            const handleMouseUp = () => {
                isDragging = false;
                document.removeEventListener('mousemove', handleMouseMove);
                document.removeEventListener('mouseup', handleMouseUp);
                
                // Save locally when dragging ends
                saveTasksLocally();
                updateSyncStatus('Saved locally ✓', 'success');
            };
            
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Initial load
            loadTasksFromJSON();
            
            // Setup periodic refresh
            setupPeriodicRefresh();
        });
        
        // Initial render (will be called again after loading from Firebase)
        renderTasks();
    </script>
</body>
</html>
